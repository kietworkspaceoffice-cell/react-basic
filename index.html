<!DOCTYPE html>
<html>
  <head>
    <title>React Basics</title>

    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        width: 100vw;
        height: 100vh;
        padding-top: 30px;
        font-family: Arial, Helvetica, sans-serif;
      }

      .js-container {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .chatContainer {
        max-width: 600px;
      }

      .messages-container {
        margin: 16px 0;
        max-height: 80vh;
        overflow-x: scroll;
      }

      .messages-container::-webkit-scrollbar {
        display: none; /* Hides the scrollbar */
}

      .chat-input-container {
        width: 600px;
        display: flex;
      }

      .send-btn {
        background-color: green;
        border: none;
        border-radius: 8px;
        height: 40px;
        width: 70px;
        color: white;
      }

      .chatInput {
        height: 40px;
        border-radius: 8px;
        margin-right: 10px;
        padding: 10px;
        border: 1px solid black;
        flex-grow: 2;
      } 

      .message {
        display: flex;
        margin: 20px 0;
        min-height: 45px;
        width: 100%;        
      }

      img{
        width: 45px;
        height: 45px;
      }

      .message-text {
        background-color: rgb(240, 240, 240);
        border-radius: 8px;
        line-height: 1;
        margin: 0 14px;
        padding: 16px 16px;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        max-width: 300px;
      }

      .spinner {
        height: 30px;
        width: 30px;
      }

      .flex-start {
        justify-content: flex-start;
      }

      .flex-end {
        justify-content: flex-end;
      }
    </style>
  </head>
  <body>
    <div class="js-container"></div>

    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>

    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>

    <script src="https://unpkg.com/supersimpledev/dayjs.js"></script>

    <script src="https://unpkg.com/supersimpledev/babel.js"></script>
    <script type="text/babel">

        function ChatInput({chatMessage, setChatMessage}) {
          const [inputChange, setInputChange] = React.useState('');
          const [isLoading, setIsLoading] = React.useState(false);

          function saveInputChange(event) {
            setInputChange(event.target.value);
          };

          async function sendMessage() {
            if (isLoading || inputChange === '') return;
            setIsLoading(true);
            setInputChange('');
            const newChatMessage = [
                ...chatMessage,
                {
                  message: inputChange,
                  sender: 'user',
                  key: crypto.randomUUID()
                }
              ];
            const loadingChat = [
                ...chatMessage,
                {
                  message: inputChange,
                  sender: 'user',
                  key: crypto.randomUUID()
                }
              ];
            setChatMessage(newChatMessage);
            
            setChatMessage([
                ...loadingChat,
                {
                  message: <img src='./loading-spinner.gif' className='spinner'/>,
                  sender: 'robot',
                  key: crypto.randomUUID()
                }
              ]); 

              const response = await Chatbot.getResponseAsync(inputChange);
              setIsLoading(false);
              setChatMessage([
                ...newChatMessage,
                {
                  message: response,
                  sender: 'robot',
                  key: crypto.randomUUID()
                }
              ]);
          }

          function enterMessage(event) {
            console.log(event.key);
            if (event.key === 'Enter') {
              sendMessage();
            } else if (event.key === 'Escape') {
              setInputChange('');
            }
          }

            return (
                <div className='chat-input-container'>
                    <input 
                      className='chatInput'
                      placeholder="Send a message to Chatbot"
                      size="50"  
                      onChange={saveInputChange}
                      value={inputChange}
                      onKeyDown={enterMessage}
                    />
                    <button className='send-btn' onClick={sendMessage}>Send</button>
                </div>
            );
        };
        
        function ChatMessage({message, sender}) {
          return (
            <div className={sender==='robot' ? 'message flex-start' : 'message flex-end'}>
              {sender === 'robot' && (
                <img src="./robot.png" />
              )}
              <div className='message-text'>{message}</div>
              {sender === 'user' && (
                <img src="./user.png" />
              )} 
            </div>
          );
        };

        function ChatMessages({chatMessage}) {
          
          return (
            <>
            {chatMessage.map((chatMessage) => {
                    return (
                      <ChatMessage
                        message = {chatMessage.message}
                        sender = {chatMessage.sender}
                        key = {chatMessage.key}
                      />
                    );
                  })} 
            </>
          )

        };

        function App() {
          const [chatMessage, setChatMessage] = React.useState([
            {
              message: 'Hello Chatbot',
              sender: 'user',
              key: crypto.randomUUID()
            },
            {
              message: 'How can I help you?',
              sender: 'robot',
              key: crypto.randomUUID()
            }
          ]);
          // const [chatMessage, setChatMessage] = array;
          // const chatMessage = array[0];
          // const setChatMessage = array[1];

            const chatRef = React.useRef(null);

            React.useEffect(() => {
              if (chatRef.current) {
                chatRef.current.scrollTop = chatRef.current.scrollHeight;
              }
            }, [chatMessage]); // mỗi lần chatMessage thay đổi → auto scroll
            
          return (
            <div className='chatContainer'>
                <ChatInput 
                  chatMessage={chatMessage}
                  setChatMessage={setChatMessage}
                /> 
                <div ref={chatRef} className='messages-container'>
                  <ChatMessages 
                    chatMessage={chatMessage}
                  />                
                </div>
            </div>
          );
        }

      const container = document.querySelector('.js-container');
      ReactDOM.createRoot(container).render(<App />);
    </script>
  </body>
</html>